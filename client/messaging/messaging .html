
<template name="messagingpage">
  <head>
  <title>messanging</title>
</head>


  {{> header}}
  {{> messanging}}
 <script>
$(window).on('beforeunload', function() {
  console.log("beforeunload called");
    changeUserStatus("offline"); 
  return 'Your own message goes here...';
});
function changeUserStatus(status){
  Meteor.call('change_user_online_status',Session.get("userId"),status,function(error,result){
             if(error){
              console.log('failed');
             }else{
              if(status == "offline"){
              console.log('sucess offline');
            
              }else{
              console.log('sucess online');
              }
             }                  
            });
}
    // Create `myApp` namespace.
window.myApp = {
  // Function to use for the `focus` event.

  onFocus: function () {
      // online
        changeUserStatus("online"); 
        
      },
  // Function to use for the `blur` event.
  onBlur: function () {
      changeUserStatus("offline");          
     }
};

/* Detect if the browser supports `addEventListener`
  Complies with DOM Event specification. */
if(window.addEventListener) {
  // Handle window's `load` event.
  window.addEventListener('load', function () {
    // Wire up the `focus` and `blur` event handlers.
    window.addEventListener('focus', window.myApp.onFocus);
    window.addEventListener('blur', window.myApp.onBlur);

  });
}
/* Detect if the browser supports `attachEvent`
  Only Internet Explorer browsers support that. */
else if(window.attachEvent) {
  // Handle window's `load` event.
  window.attachEvent('onload', function () {
    // Wire up the `focus` and `blur` event handlers.
    window.attachEvent('onfocus', window.myApp.onFocus);
    window.attachEvent('onblur', window.myApp.onBlur); 
  });
}
/* If neither event handler function exists, then overwrite 
the built-in event handers. With this technique any previous event
handlers are lost. */
else {
  // Handle window's `load` event.
  window.onload = function () {
    // Wire up the `focus` and `blur` event handlers.
    window.onfocus = window.myApp.onFocus;
    window.onblur = window.myApp.onBlur;
   
  };
}
  </script>
</template>

<template name="messanging">

  <div class="container row margin-tp contai">
      <div class="col s12 m12 l3 left_part" >

         <div class="card card_two">

 <ul class="nav navbar-nav col s12 m12 l12" style="padding: 0px;">
        <li class="dropdown col s12 m12 l12 drop_dwn_tw">
          <a href="#" class="dropdown-toggle drop_dwn_tw_a" data-toggle="dropdown"><span style="font-size: 18px;">Conversations ({{conversation_count}})</span> <i class="fa fa-ellipsis-v pull-right fa-2x pull-right"></i></a>
          <ul class="dropdown-menu">
            <li><a href="#"> Delete Conversations </a></li>
            <li class="divider"></li>
             <li><a href="#"> Delete Conversations </a></li>
          </ul>
        </li>
      </ul>
         </div>

      <div class="card" style="box-shadow: none;">
    <div class="card-content">
      <p> <input type="text" class="form-control input-sm chat_input borde_search_user" placeholder="Search Connections" style="margin-bottom: 0px;" id="search_connection_msg" /></p>
    </div>
 
    <div class="card-content">
  
      <div id="connnection">


  <ul class="collection">
 
 <div id="display_connection" class="display_hide_conversation" > 

{{#each show_connections}}
{{#each show_connections_2}}

            <li class="collection-item avatar change_msg_onright">

        <span> <img src={{profile_pic}} alt="No Image" class="circle" >
        <span class="bottom-left-2">
        
        <input type="hidden" id="hidden_conversation_user_id" value={{user_id}}  > 
  {{#if online_status}} 
        <i class="fa fa-circle color_green"></i>
     {{else}}   
        <i class="fa fa-circle color_red"></i>
  {{/if}}
        </span></span>
      <span class="title">
        <a href="" class="redirect_click_1" valu={{user_id}} >{{name}}</a>
      </span> 
  {{#each show_message_details}}
      <span class="pull-right"><p>{{calculate_time_difference last_msg_time}} </p> </span>
      
      <p class="lisimg_msg">{{last_msg}} 

      
  {{#if check_unread}}
  <span class="pull-right new_no_chat"> 
      {{unread_msg_count}}    
      </span>
    {{/if}}
  </p>
  {{/each}}    
    </li>

{{/each}}
{{/each}}

</div>

<div id="display_conversation" >
  {{#each recent_list}}
  {{#each recent_list_2}}
            <li class="collection-item avatar change_msg_onright">

        <span> <img src={{profile_pic}} alt="No Image" class="circle" >
        <span class="bottom-left-2">
        
        <input type="hidden" id="hidden_conversation_user_id" value={{user_id}}  > 
  {{#if online_status}} 
        <i class="fa fa-circle color_green"></i>
     {{else}}   
        <i class="fa fa-circle color_red"></i>
  {{/if}}
        </span></span>
      <span class="title">
        <a href="" class="redirect_click_1" valu={{user_id}} >{{name}}</a>
      </span> 
  {{#each show_message_details}}
      <span class="pull-right"><p>{{calculate_time_difference last_msg_time}} </p> </span>
      
      <p class="lisimg_msg">{{last_msg}} 

      
  {{#if check_unread}}
  <span class="pull-right new_no_chat"> 
      {{unread_msg_count}}    
      </span>
    {{/if}}
  </p>
  {{/each}}    
    </li>
     <!-- <li class="collection-item avatar">
     <span> <img src="https://i0.wp.com/tricksmaze.com/wp-content/uploads/2017/04/Stylish-Girls-Profile-Pictures-36.jpg?resize=300%2C300&ssl=1" alt="" class="circle"> <span class="bottom-left-2"><i class="fa fa-circle color_red"></i></span></span>
      <span class="title"><a href="#">Shobhita Yadav</a></span> <span class="pull-right fo_size_time"> 20m </span>
      <p class="typing">Typing ...</p>
    </li> -->
    {{/each}} 
    {{/each}}
    </div> 
  </ul>
      </div>
    </div>
  </div>
  </div>

{{#each msg_rightbox}}

  <div class="col s12 m12 l9 cbg_toofull">
     <div class="row bor_top" style="border-bottom: 1px solid #f5f5f5 !important; background-color: #f9f9f1;">
         <div class="col m1"> <img src={{profile_pic}} width="50" alt="User Avatar" class="img-circle" style="width: 50px;"> </div>
         
<div class="col m10" style="padding-left: 15px;"> <span class="font_size_19">{{name}}</span><br/>        
          {{#if check_connection}}
            Connected 
          {{else}}
            Not Connected
          {{/if}}
         </div>
         <div class="col m1 margin_to_12"> <i class="fa fa-ellipsis-v pull-right fa-2x"></i> </div>
       </div>
  <div class="card new_card"  style="margin-bottom: 0px;">
      <div id="test4">
            <div class="col-s12">
                  <div class="chatbody" >
                  <div class="panel panel-primary new_bg_for_all" style="box-shadow:none !important;">
                    <div class="panel-body msg_container_base"  id="message_container">
                    <div class="row msg_container base_sent">
                      <div class="col l12 m12 s12" style="padding-right: 0px;">
 <ul class="collection">
 {{#each show_message_array}}
 <!-- {{msg_text}}<br> -->
        {{#if sentby_other_user}}
    <li class="collection-item avatar">
      <span>
          {{#if equals delivery_status 'read'}} 
        <div class="messages messages_us msg_receive text-right" style="background-color:green ! important" >
            <p style="text-align: justify; ">  {{msg_text}}  </p>
            <time datetime="2009-11-13T20:00"><span class="time fo_size_time">
               <p>{{calculate_time_difference sentAt}}</p>
            </span></time>
                            </div>
          {{else if equals delivery_status 'delivered' }}
          <div class="messages messages_us msg_receive text-right" style="background-color:yellow ! important" >
            <p style="text-align: justify">  {{msg_text}}  </p>
            <time datetime="2009-11-13T20:00"><span class="time fo_size_time">
               <p>{{calculate_time_difference sentAt}}</p>
            </span></time>
          </div>
           {{else}}
          <div class="messages messages_us msg_receive text-right" style="background-color:red ! important" >
            <p style="text-align: justify">  {{msg_text}}  </p>
            <time datetime="2009-11-13T20:00"><span class="time fo_size_time">
               <p>{{calculate_time_difference sentAt}}</p>
            </span></time>
          </div>
          {{/if}} 

        




      </span>
       <div style="clear: both;"> </div>
    </li>
    {{else}}
    <li class="collection-item avatar">
    {{#each msg_rightbox}}  
        <span> <img src={{profile_pic}} alt="NO Image" class="circle"> <span class="bottom-left"></span></span> 
    {{/each}}
      <span>
        <div class="messages messages_you msg_receive text-left">
                                <p style="text-align: justify" >  {{msg_text}} </p>
                              <time datetime="2009-11-13T20:00">
                                  <span class="time fo_size_time">
                                 <p>{{calculate_time_difference sentAt}}</p>
                                    </span>
                             </time>
                            </div>
                                  </span>
                                  <div style="clear: both;"> </div>
    </li>
{{/if}}
{{else}}
       {{> spinner}}
{{/each}}
  </ul>
                        </div>

                    </div>                
                </div>
                     {{#if typing_gif}}  
<img src="https://loading.io/spinners/typing/lg.-text-entering-comment-loader.gif" style="height:100px; width:100px;" class="pull-left" >
                     {{/if}}    

                <div class="panel-footer padding_0">
                    <div class="input-controls-container" style="padding-top: 10px;">
                      
                      <form id="msg_input_form" >
                      <textarea class="form-control " placeholder="Type a message here ..." style="border: none;" id="msg_text" ></textarea>
                      <input type="hidden" id="send_msg" >
                    </form>

                   </div>
                </div>
        </div>

<script type="text/javascript">
                    $('#msg_input_form').keypress(function(e){
                        var code = e.keyCode || e.which;

                        if( code === 13 ) {
                            e.preventDefault();
                            $("#send_msg").click();
                        };
                    });
</script>            

                 </div>
             </div>
     </div>
  </div>
  </div>
  
{{else}}
       {{> spinner}}
{{/each}}

</div>
</template>




